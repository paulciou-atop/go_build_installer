name: Build Windows Installer 
on: push
  
jobs:
  Setting-running-env:
    runs-on: windows-latest
    steps:
      - name: Checkout Repository Code
        uses: actions/checkout@v3
        
      - uses: actions/setup-go@v3
        with:
          go-version: '^1.18.0' # The Go version to download (if necessary) and use.
      - run: go version
      - name: install tools
        run: |
          choco source add -n=mh-cbon -s="https://api.bintray.com/nuget/mh-cbon/choco"
          choco install changelog gh-api-cli -y 
          choco install go-msi 
          choco install wixtoolset
          refreshenv
          set GH_APP=%APPVEYOR_PROJECT_NAME%
          set GH_USER=%APPVEYOR_ACCOUNT_NAME%
          set VERSION=%APPVEYOR_REPO_TAG_NAME%
          set VERSION=1.0.2
          
          
          curl -fsSk -o jfrog.exe -L "https://api.bintray.com/content/jfrog/jfrog-cli-go/$latest/jfrog-cli-windows-amd64/jfrog.exe?bt_package=jfrog-cli-windows-amd64"
          go get -u github.com/mh-cbon/never-fail
          go get -u github.com/Masterminds/glide
          glide install  
      - name: build source code
        run: | 
          cd source
          
          set GOARCH=amd64
          go build -o listen13380.exe --ldflags "-X main.VERSION=%VERSION%" main.go
          XCOPY /I /E templates C:\go-msi\templates
          
          COPY source/listen13380.exe exefile/
          cd ..
      - name: build installer
        run: |
          go-msi make --msi nms.%VERSION%.msi --version %VERSION%
          dir *msi
          
          
    
  

      
